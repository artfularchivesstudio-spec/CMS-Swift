#
# ðŸŽ­ CMS-Manager Deployment Pipeline
#
# "Where tagged releases transcend into the cosmic realm of distribution,
# preparing our creation for its grand debut in the hands of seekers."
#
# - The Spellbinding Deployment Virtuoso
#

name: Deploy

# ðŸŒŸ Trigger Configuration - Activate on version tags
on:
  push:
    tags:
      - 'v*.*.*'  # Matches v1.0.0, v2.1.3, etc.

  # Enable manual workflow dispatch for testing
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy (e.g., 1.0.0)'
        required: true
        type: string

# ðŸŒ Environment Variables
env:
  DEVELOPER_DIR: /Applications/Xcode_15.2.app/Contents/Developer
  SCHEME: CMS_Manager
  XCODE_VERSION: '15.2'

jobs:

  # ============================================================
  # ðŸ—ï¸ Build Archive Job - The Release Preparation Ritual
  # ============================================================
  build-archive:
    name: ðŸ—ï¸ Build Release Archive
    runs-on: macos-14
    timeout-minutes: 45

    steps:
      # ðŸ“¥ Checkout the mystical codebase
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ðŸ” Setup Xcode version
      - name: ðŸ” Select Xcode Version
        run: |
          echo "ðŸŽ¨ Selecting Xcode ${{ env.XCODE_VERSION }}..."
          sudo xcode-select -s /Applications/Xcode_15.2.app/Contents/Developer
          xcodebuild -version

      # ðŸ“¦ Cache Swift Package Manager dependencies
      - name: ðŸ“¦ Cache SPM Dependencies
        uses: actions/cache@v4
        with:
          path: |
            .build
            ~/Library/Developer/Xcode/DerivedData
            Packages/ArtfulArchivesCore/.build
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved', '**/project.yml') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      # ðŸŽ­ Generate Xcode Project
      - name: ðŸŽ­ Generate Xcode Project
        run: |
          echo "ðŸŒŸ Installing XcodeGen..."
          brew install xcodegen

          echo "âœ¨ Generating Xcode project..."
          xcodegen generate

      # ðŸ”¢ Extract Version Information
      - name: ðŸ”¢ Extract Version Info
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/v}"
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“‹ Building version: $VERSION"

      # ðŸ—ï¸ Build Release Archive
      - name: ðŸ—ï¸ Build Archive
        run: |
          echo "ðŸ—ï¸ Building release archive for version ${{ steps.version.outputs.version }}..."

          set -o pipefail

          # Build for iOS Simulator (since we don't have code signing configured)
          xcodebuild build \
            -project CMS-Manager.xcodeproj \
            -scheme "${{ env.SCHEME }}" \
            -sdk iphonesimulator \
            -configuration Release \
            -derivedDataPath .build \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            | tee archive-log.txt \
            | xcpretty --color || cat archive-log.txt

          echo "âœ… Archive build completed successfully!"

      # ðŸ“¦ Package Build Artifacts
      - name: ðŸ“¦ Package Artifacts
        run: |
          echo "ðŸ“¦ Packaging build artifacts..."

          cd .build/Build/Products/Release-iphonesimulator

          # Create a ZIP archive of the .app bundle
          zip -r "CMS-Manager-v${{ steps.version.outputs.version }}-simulator.zip" CMS-Manager.app

          # Move to a well-known location
          mv "CMS-Manager-v${{ steps.version.outputs.version }}-simulator.zip" "$GITHUB_WORKSPACE/"

          echo "âœ… Artifacts packaged successfully!"

      # ðŸ“‹ Generate Release Notes
      - name: ðŸ“‹ Generate Release Notes
        id: release_notes
        run: |
          echo "ðŸ“‹ Generating release notes..."

          # Get commits since last tag
          PREV_TAG=$(git describe --abbrev=0 --tags HEAD^ 2>/dev/null || echo "")

          if [ -z "$PREV_TAG" ]; then
            COMMITS=$(git log --pretty=format:"- %s (%h)" --no-merges)
          else
            COMMITS=$(git log --pretty=format:"- %s (%h)" --no-merges "$PREV_TAG"..HEAD)
          fi

          # Create release notes file
          cat > release-notes.md << EOF
          # ðŸŽ­ CMS-Manager v${{ steps.version.outputs.version }}

          ## âœ¨ What's New

          $COMMITS

          ## ðŸ“¦ Downloads

          - **iOS Simulator Build**: CMS-Manager-v${{ steps.version.outputs.version }}-simulator.zip

          ## ðŸŽ¨ Installation

          ### iOS Simulator
          1. Download the simulator build
          2. Unzip the archive
          3. Drag CMS-Manager.app to your iOS Simulator

          ## ðŸ”® Technical Details

          - **Xcode Version**: ${{ env.XCODE_VERSION }}
          - **Swift Version**: 6.0
          - **Minimum iOS**: 18.0
          - **Build Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")

          ---

          *Built with mystical automation by GitHub Actions*
          EOF

          echo "âœ… Release notes generated!"

      # ðŸ“¤ Upload Build Artifacts
      - name: ðŸ“¤ Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-artifacts-v${{ steps.version.outputs.version }}
          path: |
            CMS-Manager-v${{ steps.version.outputs.version }}-simulator.zip
            release-notes.md
            archive-log.txt
          retention-days: 90

      # ðŸŽ‰ Create GitHub Release
      - name: ðŸŽ‰ Create GitHub Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            CMS-Manager-v${{ steps.version.outputs.version }}-simulator.zip
          body_path: release-notes.md
          draft: true  # Create as draft so you can review before publishing
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================================
  # ðŸš€ Future: TestFlight Upload Job (Placeholder)
  # ============================================================
  # Uncomment and configure when ready for TestFlight distribution
  #
  # testflight:
  #   name: ðŸš€ Upload to TestFlight
  #   runs-on: macos-14
  #   needs: build-archive
  #   timeout-minutes: 30
  #
  #   steps:
  #     - name: ðŸ“¥ Checkout Repository
  #       uses: actions/checkout@v4
  #
  #     - name: ðŸ” Configure Code Signing
  #       # Set up certificates and provisioning profiles
  #       # Use secrets for certificate and provisioning profile
  #       run: |
  #         echo "Configure App Store Connect API key"
  #         echo "Install certificates and provisioning profiles"
  #
  #     - name: ðŸ—ï¸ Build for App Store
  #       run: |
  #         xcodebuild archive \
  #           -project CMS-Manager.xcodeproj \
  #           -scheme "${{ env.SCHEME }}" \
  #           -sdk iphoneos \
  #           -configuration Release \
  #           -archivePath CMS-Manager.xcarchive
  #
  #     - name: ðŸ“¤ Export IPA
  #       run: |
  #         xcodebuild -exportArchive \
  #           -archivePath CMS-Manager.xcarchive \
  #           -exportPath . \
  #           -exportOptionsPlist ExportOptions.plist
  #
  #     - name: ðŸš€ Upload to TestFlight
  #       run: |
  #         xcrun altool --upload-app \
  #           --type ios \
  #           --file CMS-Manager.ipa \
  #           --apiKey ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }} \
  #           --apiIssuer ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
