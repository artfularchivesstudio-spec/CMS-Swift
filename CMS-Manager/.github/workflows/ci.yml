#
# ðŸŽ­ CMS-Manager Continuous Integration Pipeline
#
# "Where every commit enters the grand theater of automated testing,
# ensuring quality flows through our digital masterpiece like a
# perfectly orchestrated symphony."
#
# - The Spellbinding CI/CD Maestro
#

name: CI

# ðŸŒŸ Trigger Configuration - When the magical rituals begin
on:
  # Activate on pushes to the main branch
  push:
    branches:
      - main

  # Activate on all pull requests
  pull_request:
    branches:
      - '**'

  # Enable manual workflow dispatch for on-demand testing
  workflow_dispatch:
    inputs:
      device:
        description: 'iOS Simulator Device'
        required: false
        default: 'iPhone 15 Pro'
        type: string
      clean_build:
        description: 'Perform clean build'
        required: false
        default: false
        type: boolean

# ðŸŽ¯ Concurrency Control - Only one performance at a time per branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# ðŸŒ Environment Variables - The cosmic configuration
env:
  DEVELOPER_DIR: /Applications/Xcode_15.2.app/Contents/Developer
  SCHEME: CMS_Manager
  IOS_SIMULATOR_DEVICE: ${{ inputs.device || 'iPhone 15 Pro' }}
  XCODE_VERSION: '15.2'

jobs:

  # ============================================================
  # ðŸ§ª Test Job - The Grand Testing Performance
  # ============================================================
  test:
    name: ðŸ§ª Run Tests
    runs-on: macos-14
    timeout-minutes: 30

    steps:
      # ðŸ“¥ Checkout the mystical codebase
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better context

      # ðŸ” Setup Xcode version
      - name: ðŸ” Select Xcode Version
        run: |
          echo "ðŸŽ¨ Selecting Xcode ${{ env.XCODE_VERSION }}..."
          sudo xcode-select -s /Applications/Xcode_15.2.app/Contents/Developer
          xcodebuild -version

      # ðŸ“¦ Cache Swift Package Manager dependencies
      - name: ðŸ“¦ Cache SPM Dependencies
        uses: actions/cache@v4
        with:
          path: |
            .build
            ~/Library/Developer/Xcode/DerivedData
            Packages/ArtfulArchivesCore/.build
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved', '**/project.yml') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      # ðŸŽ­ Generate Xcode Project using XcodeGen
      - name: ðŸŽ­ Generate Xcode Project
        run: |
          echo "ðŸŒŸ Installing XcodeGen..."
          brew install xcodegen

          echo "âœ¨ Generating Xcode project from project.yml..."
          cd "$GITHUB_WORKSPACE"
          xcodegen generate

          echo "âœ… Xcode project generated successfully!"

      # ðŸ—ï¸ Build for Testing
      - name: ðŸ—ï¸ Build for Testing
        run: |
          echo "ðŸ—ï¸ Building CMS-Manager for testing..."

          set -o pipefail

          xcodebuild build-for-testing \
            -project CMS-Manager.xcodeproj \
            -scheme "${{ env.SCHEME }}" \
            -sdk iphonesimulator \
            -destination "platform=iOS Simulator,name=${{ env.IOS_SIMULATOR_DEVICE }}" \
            -derivedDataPath .build \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            ONLY_ACTIVE_ARCH=NO \
            | tee build-log.txt \
            | xcpretty --color || cat build-log.txt

      # ðŸŽª Run Unit Tests
      - name: ðŸŽª Run Unit Tests
        run: |
          echo "ðŸŽª Running unit tests..."

          set -o pipefail

          xcodebuild test-without-building \
            -project CMS-Manager.xcodeproj \
            -scheme "${{ env.SCHEME }}" \
            -sdk iphonesimulator \
            -destination "platform=iOS Simulator,name=${{ env.IOS_SIMULATOR_DEVICE }}" \
            -derivedDataPath .build \
            -resultBundlePath .build/TestResults.xcresult \
            -enableCodeCoverage YES \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            | tee test-log.txt \
            | xcpretty --color --test || cat test-log.txt

      # ðŸ“Š Generate Code Coverage Report
      - name: ðŸ“Š Generate Coverage Report
        if: always()
        run: |
          echo "ðŸ“Š Generating code coverage report..."

          if [ -d ".build/TestResults.xcresult" ]; then
            xcrun xccov view --report .build/TestResults.xcresult > coverage-report.txt
            cat coverage-report.txt

            # Extract coverage percentage
            COVERAGE=$(xcrun xccov view --report .build/TestResults.xcresult | grep -E "CMS-Manager\.app" | awk '{print $4}' | head -1)
            echo "âœ¨ Code Coverage: $COVERAGE"
          else
            echo "âš ï¸ No test results found"
          fi

      # ðŸ“¦ Upload Test Results
      - name: ðŸ“¦ Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            .build/TestResults.xcresult
            coverage-report.txt
            test-log.txt
            build-log.txt
          retention-days: 30

      # ðŸ“¸ Upload Snapshot Test Failures
      - name: ðŸ“¸ Upload Snapshot Failures
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: snapshot-test-failures
          path: |
            CMS-ManagerTests/Snapshots/__Failures__/
          retention-days: 30
          if-no-files-found: ignore

  # ============================================================
  # ðŸ—ï¸ Build Job - The Release Construction Ritual
  # ============================================================
  build:
    name: ðŸ—ï¸ Build Release
    runs-on: macos-14
    timeout-minutes: 30
    needs: test  # Only build if tests pass

    steps:
      # ðŸ“¥ Checkout the mystical codebase
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      # ðŸ” Setup Xcode version
      - name: ðŸ” Select Xcode Version
        run: |
          echo "ðŸŽ¨ Selecting Xcode ${{ env.XCODE_VERSION }}..."
          sudo xcode-select -s /Applications/Xcode_15.2.app/Contents/Developer
          xcodebuild -version

      # ðŸ“¦ Cache Swift Package Manager dependencies
      - name: ðŸ“¦ Cache SPM Dependencies
        uses: actions/cache@v4
        with:
          path: |
            .build
            ~/Library/Developer/Xcode/DerivedData
            Packages/ArtfulArchivesCore/.build
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved', '**/project.yml') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      # ðŸŽ­ Generate Xcode Project
      - name: ðŸŽ­ Generate Xcode Project
        run: |
          echo "ðŸŒŸ Installing XcodeGen..."
          brew install xcodegen

          echo "âœ¨ Generating Xcode project..."
          xcodegen generate

      # ðŸ—ï¸ Build for iOS Simulator (Release)
      - name: ðŸ—ï¸ Build for iOS Simulator
        run: |
          echo "ðŸ—ï¸ Building CMS-Manager for Release..."

          set -o pipefail

          xcodebuild build \
            -project CMS-Manager.xcodeproj \
            -scheme "${{ env.SCHEME }}" \
            -sdk iphonesimulator \
            -destination "platform=iOS Simulator,name=${{ env.IOS_SIMULATOR_DEVICE }}" \
            -configuration Release \
            -derivedDataPath .build \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            ONLY_ACTIVE_ARCH=NO \
            | tee build-release-log.txt \
            | xcpretty --color || cat build-release-log.txt

          echo "âœ… Release build completed successfully!"

      # ðŸ“¦ Archive Build Artifacts
      - name: ðŸ“¦ Archive Build Artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: release-build-iphonesimulator
          path: |
            .build/Build/Products/Release-iphonesimulator/CMS-Manager.app
            build-release-log.txt
          retention-days: 7

  # ============================================================
  # ðŸ§¹ Lint Job - The Code Style Guardian (Optional)
  # ============================================================
  lint:
    name: ðŸ§¹ SwiftLint
    runs-on: macos-14
    timeout-minutes: 10

    steps:
      # ðŸ“¥ Checkout the mystical codebase
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      # ðŸ§¹ Install SwiftLint
      - name: ðŸ§¹ Install SwiftLint
        run: |
          echo "ðŸŒŸ Installing SwiftLint..."
          brew install swiftlint
          swiftlint version

      # ðŸ” Run SwiftLint
      - name: ðŸ” Run SwiftLint
        run: |
          echo "ðŸ” Running SwiftLint analysis..."

          # Run SwiftLint with reporter for better CI output
          swiftlint lint --reporter github-actions-logging

          echo "âœ… SwiftLint analysis complete!"
        continue-on-error: true  # Don't fail the build on lint warnings

  # ============================================================
  # ðŸ“Š Summary Job - The Grand Performance Report
  # ============================================================
  summary:
    name: ðŸ“Š CI Summary
    runs-on: macos-14
    needs: [test, build, lint]
    if: always()

    steps:
      - name: ðŸ“Š Generate Summary
        run: |
          echo "# ðŸŽ­ CMS-Manager CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸŒŸ Build Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Actor:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Simulator:** ${{ env.IOS_SIMULATOR_DEVICE }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Xcode:** ${{ env.XCODE_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸŽª Job Results" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ§ª Tests: ${{ needs.test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ—ï¸ Build: ${{ needs.build.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ§¹ Lint: ${{ needs.lint.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.test.result }}" == "success" ] && [ "${{ needs.build.result }}" == "success" ]; then
            echo "### ðŸŽ‰ âœ¨ All jobs completed successfully! The show was a masterpiece! âœ¨ ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ðŸ’¥ Some jobs encountered issues. Review the logs for details." >> $GITHUB_STEP_SUMMARY
          fi
